name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push to gh-pages and update badges

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup C++
        uses: aminya/setup-cpp@v1
        with:
          compiler: gcc-14
          gcov: true
          cmake: true
          ninja: true

      - name: Install LCOV
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Configure CMake
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON

      - name: Build
        run: cmake --build build

      - name: Run Tests
        working-directory: build
        run: ctest --output-on-failure

      # --- COVERAGE GENERATION ---
      - name: Generate Coverage Report
        run: |
          lcov --gcov-tool gcov-14 --capture --directory . --output-file coverage.info
          
          lcov --extract coverage.info "$(pwd)/include/*" "$(pwd)/src/*" --output-file coverage_clean.info --ignore-errors unused          
          
          genhtml coverage_clean.info --output-directory coverage_html
          
          COVERAGE=$(lcov --summary coverage_clean.info | grep "lines......" | cut -d ':' -f 2 | cut -d '%' -f 1 | tr -d '[:space:]')
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "BADGE_COLOR=red" >> $GITHUB_ENV
          elif (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "BADGE_COLOR=orange" >> $GITHUB_ENV
          else
            echo "BADGE_COLOR=brightgreen" >> $GITHUB_ENV
          fi

      # --- BADGE GENERATION (Gist Method) ---
      # This updates a Gist with the JSON data for shields.io
      - name: Create Coverage Badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }} # You need to create a Gist and a Token
          gistID: 1a5fc2bac537cce52c590a74d4d192e3
          filename: coverage.json
          label: Coverage
          message: ${{ env.COVERAGE }}%
          color: ${{ env.BADGE_COLOR }}
          namedLogo: c++

      # --- REPORT DEPLOYMENT ---
      # This pushes the HTML report to a 'gh-pages' branch so you can view it in browser
      - name: Deploy Report to GitHub Pages
        if: github.ref == 'refs/heads/master' # Only deploy on master push
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage_html
      
      - name: Extract Test Results
        run: |
          # Count passed tests from ctest output (adjusting based on your test runner output)
          # Assuming your TEST_SUITE prints "X passed, Y failed."
          PASSED=$(grep -h "passed" build/Testing/Temporary/LastTest.log | awk '{print $1}' | awk '{sum+=$1} END {print sum}')
          TOTAL=$(grep -h "passed" build/Testing/Temporary/LastTest.log | awk '{print $1+$3}' | awk '{sum+=$1} END {print sum}')
          echo "TESTS_PASSED=$PASSED/$TOTAL" >> $GITHUB_ENV

      - name: Update Test Badge
        if: always() # Update even if tests fail so the badge turns red
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: 1a5fc2bac537cce52c590a74d4d192e3
          filename: tests.json
          label: Tests
          # If the 'Run Tests' step succeeded, show 'passing', otherwise 'failing'
          message: ${{ steps.run_tests.outcome == 'success' && 'passing' || 'failing' }}
          color: ${{ steps.run_tests.outcome == 'success' && 'brightgreen' || 'red' }}