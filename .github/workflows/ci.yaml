name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to push to gh-pages and update badges

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup C++
        uses: aminya/setup-cpp@v1
        with:
          compiler: gcc-14
          gcov: true
          cmake: true
          ninja: true

      - name: Install LCOV
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Configure CMake
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON

      - name: Build
        run: cmake --build build

      - name: Run Tests
        working-directory: build
        run: ctest --output-on-failure
        continue-on-error: true

      # --- COVERAGE GENERATION ---
      - name: Generate Coverage Report
        run: |
          lcov --gcov-tool gcov-14 --capture --directory . --output-file coverage.info
          
          lcov --extract coverage.info "$(pwd)/include/*" "$(pwd)/src/*" --output-file coverage_clean.info --ignore-errors unused          
          
          genhtml coverage_clean.info --output-directory coverage_html
          
          COVERAGE=$(lcov --summary coverage_clean.info | grep "lines......" | cut -d ':' -f 2 | cut -d '%' -f 1 | tr -d '[:space:]')
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "BADGE_COLOR=red" >> $GITHUB_ENV
          elif (( $(echo "$COVERAGE < 90" | bc -l) )); then
            echo "BADGE_COLOR=orange" >> $GITHUB_ENV
          else
            echo "BADGE_COLOR=brightgreen" >> $GITHUB_ENV
          fi

      # --- BADGE GENERATION (Gist Method) ---
      # This updates a Gist with the JSON data for shields.io
      - name: Create Coverage Badge
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }} # You need to create a Gist and a Token
          gistID: 1a5fc2bac537cce52c590a74d4d192e3
          filename: coverage.json
          label: Coverage
          message: ${{ env.COVERAGE }}%
          color: ${{ env.BADGE_COLOR }}
          namedLogo: c++

      # --- REPORT DEPLOYMENT ---
      # This pushes the HTML report to a 'gh-pages' branch so you can view it in browser
      - name: Deploy Report to GitHub Pages
        if: github.ref == 'refs/heads/master' # Only deploy on master push
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage_html
      
      - name: Extract Test Results
        if: always()
        run: |
          LOG_FILE="build/Testing/Temporary/LastTest.log"
          
          # Default values
          TESTS_OUTCOME="failing"
          TESTS_COLOR="red"

          # If the previous step actually succeeded
          if [ "${{ steps.run_tests.outcome }}" == "success" ]; then
            TESTS_COLOR="brightgreen"
            if [ -f "$LOG_FILE" ]; then
              # Grab the "X/X" part from CTest summary
              SUMMARY=$(grep -i "tests passed" "$LOG_FILE" | tail -n 1 || echo "")
              TOTAL=$(echo "$SUMMARY" | sed -n 's/.*out of \([0-9]*\).*/\1/p')
              if [ -n "$TOTAL" ]; then
                TESTS_OUTCOME="$TOTAL/$TOTAL"
              else
                TESTS_OUTCOME="passing"
              fi
            else
              TESTS_OUTCOME="passing"
            fi
          fi

          echo "FINAL_TESTS_MSG=$TESTS_OUTCOME" >> $GITHUB_ENV
          echo "FINAL_TESTS_COLOR=$TESTS_COLOR" >> $GITHUB_ENV

      - name: Update Test Badge
        if: always()
        uses: schneegans/dynamic-badges-action@v1.7.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: 1a5fc2bac537cce52c590a74d4d192e3
          filename: tests.json
          label: Tests
          message: ${{ env.FINAL_TESTS_MSG }}
          color: ${{ env.FINAL_TESTS_COLOR }}